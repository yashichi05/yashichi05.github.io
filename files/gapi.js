var sheetrange = { //寫入的範圍
    resStock: {
        gid: '19ZXwhENPrLmLURoKO4xXoCDahpyMG5wuU_8xsU74kyI',
        gname: '工作表1!',
        col: {
            piso: 'B', //ISO
            pname: 'C', //產品名稱
            ptype: 'D', //款式
            pcount: 'G' //數量
        }
    },
    facebookID: {
        gid: '1f36qa112A6stUaFV94SYs-IIs13n6_mATzm_CPB-_IQ',
        gname: 'FB!',
        col: {
            oid: '', //訂單編號
            oname: 'B', //姓名
            otel: '', //電話
            oaccount: '', //帳號
            piso: 'D', //ISO
            pname: 'E', //產品名稱
            ptype: 'F', //款式
            pcount: 'G', //數量
            pprice: 'H', //單價
            pallprice: 'I', //總價
            oship: 'J', //貨運
            oshipprice: 'K', //運費
            oprice: 'L', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'M' //發票
        }
    },
    yahooID: {
        gid: '1DX4rBZ55EnP8-Falc1mxYiS487MhualwAohmv_d07HI',
        gname: '大航家!',
        col: {
            oid: 'B', //訂單編號
            oname: 'C', //姓名
            otel: 'D', //電話
            oaccount: 'E', //帳號
            piso: 'F', //ISO
            pname: 'G', //產品名稱
            ptype: 'H', //款式
            pcount: 'I', //數量
            pprice: 'J', //單價
            pallprice: 'K', //總價
            oship: 'L', //貨運
            oshipprice: 'M', //運費
            oprice: 'O', //訂單金額
            ofee: '', //手續費
            odiscount: 'N', //折扣
            oreceipt: 'P' //發票
        }
    },
    LINEID: {
        gid: '1NwTr2_GNxBEQjZDDYiiT_SkUV9e-8i58qhNHA20_RyE',
        gname: '工作表1!',
        col: {
            oid: 'B', //訂單編號
            oname: 'B', //姓名
            otel: 'C', //電話
            oaccount: '', //帳號
            piso: 'D', //ISO
            pname: 'E', //產品名稱
            ptype: 'F', //款式
            pcount: 'G', //數量
            pprice: 'H', //單價
            pallprice: 'I', //總價
            oship: 'J', //貨運
            oshipprice: '', //運費
            oprice: 'K', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'L' //發票
        }
    },
    FacebookID: {
        gid: '1f36qa112A6stUaFV94SYs-IIs13n6_mATzm_CPB-_IQ',
        gname: 'FB!',
        col: {
            oid: 'A', //訂單編號
            oname: 'B', //姓名
            otel: 'C', //電話
            oaccount: '', //帳號
            piso: 'D', //ISO
            pname: 'E', //產品名稱
            ptype: 'F', //款式
            pcount: 'G', //數量
            pprice: 'H', //單價
            pallprice: 'I', //總價
            oship: 'J', //貨運
            oshipprice: 'K', //運費
            oprice: 'L', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'M' //發票
        }
    },
    yahootID: {
        gid: '1DX4rBZ55EnP8-Falc1mxYiS487MhualwAohmv_d07HI',
        gname: '梓原!',
        col: {
            oid: 'B', //訂單編號
            oname: 'C', //姓名
            otel: 'D', //電話
            oaccount: 'E', //帳號
            piso: 'F', //ISO
            pname: 'G', //產品名稱
            ptype: 'H', //款式
            pcount: 'I', //數量
            pprice: 'J', //單價
            pallprice: 'K', //總價
            oship: 'L', //貨運
            oshipprice: 'M', //運費
            oprice: 'O', //訂單金額
            ofee: '', //手續費
            odiscount: 'N', //折扣
            oreceipt: 'P' //發票
        }
    },
    shopeeID: {
        gid: '1nplThOG2vqcdia3Uht1Niv9oW7sfhU2YpbbBPDwmlcc',
        gname: '訂單明細!',
        col: {
            oid: 'B', //訂單編號
            oname: 'C', //姓名
            otel: 'D', //電話
            oaccount: 'E', //帳號
            piso: 'F', //ISO
            pname: 'G', //產品名稱
            ptype: 'H', //款式
            pcount: 'I', //數量
            pprice: 'J', //單價
            pallprice: 'K', //總價
            oship: 'L', //貨運
            oshipprice: 'M', //運費
            oprice: 'N', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'O' //發票
        }
    },
    shopee_bigID: {
        gid: '1nplThOG2vqcdia3Uht1Niv9oW7sfhU2YpbbBPDwmlcc',
        gname: '大航家!',
        col: {
            oid: 'B', //訂單編號
            oname: 'C', //姓名
            otel: 'D', //電話
            oaccount: 'E', //帳號
            piso: 'F', //ISO
            pname: 'G', //產品名稱
            ptype: 'H', //款式
            pcount: 'I', //數量
            pprice: 'J', //單價
            pallprice: 'K', //總價
            oship: 'L', //貨運
            oshipprice: 'M', //運費
            oprice: 'N', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'O' //發票
        }
    },
    pchomedID: {
        gid: '1NzSk2lwQ456eflqdnKwWWRy6ZIZsbf5Bj0BGcxcjqSI',
        gname: '大一!',
        col: {
            oid: 'B', //訂單編號
            oname: 'C', //姓名
            otel: 'D', //電話
            oaccount: '', //帳號
            piso: 'E', //ISO
            pname: 'F', //產品名稱
            ptype: 'G', //款式
            pcount: 'H', //數量
            pprice: 'I', //單價
            pallprice: 'J', //總價
            oship: 'K', //貨運
            oshipprice: 'L', //運費
            oprice: 'M', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'M' //發票
        }
    },
    pchometID: {
        gid: '1NzSk2lwQ456eflqdnKwWWRy6ZIZsbf5Bj0BGcxcjqSI',
        gname: '梓原!',
        col: {
            oid: 'B', //訂單編號
            oname: 'C', //姓名
            otel: 'D', //電話
            oaccount: '', //帳號
            piso: 'E', //ISO
            pname: 'F', //產品名稱
            ptype: 'G', //款式
            pcount: 'H', //數量
            pprice: 'I', //單價
            pallprice: 'J', //總價
            oship: 'K', //貨運
            oshipprice: 'L', //運費
            oprice: 'M', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'N' //發票
        }
    },
    RutenID: {
        gid: '1vt6bzGSpS8StKdWbIk7gi_dtJ7w1OBIOODiA0eVFARw',
        gname: '工作表1!',
        col: {
            oid: 'B', //訂單編號
            oname: 'D', //姓名
            otel: 'E', //電話
            oaccount: 'C', //帳號
            piso: 'F', //ISO
            pname: 'G', //產品名稱
            ptype: 'H', //款式
            pcount: 'I', //數量
            pprice: 'J', //單價
            pallprice: 'K', //總價
            oship: 'L', //貨運
            oshipprice: 'M', //運費
            oprice: 'N', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: 'O' //發票
        }
    },
    songuoID: {
        gid: '12HcyDkrHWGG2w1hJIjM1tk7BQqi2-HumCQehwuah0ro',
        gname: '工作表1!',
        col: {
            oid: 'B', //訂單編號
            oname: 'C', //姓名
            otel: 'D', //電話
            oaccount: '', //帳號
            piso: 'E', //ISO
            pname: 'F', //產品名稱
            ptype: 'G', //款式
            pcount: 'H', //數量
            pprice: 'J', //單價
            pallprice: 'J', //總價
            oship: 'O', //貨運
            oshipprice: '', //運費
            oprice: 'M', //訂單金額
            ofee: 'K', //手續費
            odiscount: 'L', //折扣
            oreceipt: 'N' //發票
        }
    },
    buy123ID: {
        gid: '1snj6VvwDoMel448xnLlPCWwECTxkEs4sl5OfEWlezJs',
        gname: '工作表1!',
        col: {
            oid: 'C', //訂單編號
            oname: 'D', //姓名
            otel: '', //電話
            oaccount: '', //帳號
            piso: 'E', //ISO
            pname: 'F', //產品名稱
            ptype: 'G', //款式
            pcount: 'H', //數量
            pprice: '', //單價
            pallprice: 'J', //總價
            oship: 'K', //貨運
            oshipprice: '', //運費
            oprice: 'J', //訂單金額
            ofee: '', //手續費
            odiscount: '', //折扣
            oreceipt: '' //發票
        }
    }
}

var CLIENT_ID = '830462167717-2hh5u6k5fo2iuscsfohas2fide5n9g24.apps.googleusercontent.com';
var API_KEY = 'AIzaSyBj8xjZ75lF9oEirYXbEQA-pyJcZKgkHgE';
var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
var SCOPES = "https://www.googleapis.com/auth/spreadsheets";



function GsubmitStockData(iso, count, pindex) { //
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheetrange.resStock.gid,
        range: sheetrange.resStock.gname + "B:R" //原本只有取道O蘭，但因為鎖定的取貨蘭 包括本身即之後的欄位為空，會導致陣列較短，無法取值計算 而沒法附值
    }).then(function (response) {
        var stockISOAry = [];
        var setArysite
        if (webform.gsheetcol == "K") { //判斷KLMN 陣列位置 用來計算剩餘數量，不影響寫入
            setArysite = 9;
        } else if (webform.gsheetcol == "L") {
            setArysite = 10;

        } else if (webform.gsheetcol == "M") {
            setArysite = 11;

        } else if (webform.gsheetcol == "N") {
            setArysite = 12;

        }
        //console.log(response.result.values)
        for (var i = 0; i < response.result.values.length; i++) { //提取ISO
            stockISOAry.push(response.result.values[i][0]);
        }
        var findRow = stockISOAry.indexOf(iso) + 1; //找到的ISO列數
        if (pindex == productlist.products.length - 2) { //最後一個商品時//解放按鈕 -2是因為index從0開始 商品列又固定多1  因為後面找不到值會return 所以在這
            buttonevent.activButton()
            if (buttonevent.btnevent == 2) { //如果是刪除事件
                $("#orderdel").attr('disabled', 'disabled') //鎖定刪除按鈕
                $("#ordersubmit").removeAttr('disabled') //激活送出紐
                buttonevent.btnevent = '' //還原初始值
            }
        }
        if (findRow - 1 == -1 || iso == "") { //如果找不到ISO 會返回-1 iso為空白字元 會自動找到80列 所以強制RETURN
            var errortext = "$('#getOres-" + pindex + "').text('找不到');";
            eval(errortext)
            return
        }
        var calV1 = response.result.values[findRow - 1][13] - count; //計算拍賣架上取貨後剩餘數量
        var caltext1 = "$('#getOres-" + pindex + "').text('架:" + calV1 + "');";
        var calV2 = response.result.values[findRow - 1][7]; //顯示批發倉庫數量
        var caltext2 = "$('#getBres-" + pindex + "').text('庫:" + calV2 + "');";
        count = Number(response.result.values[findRow - 1][setArysite]) + Number(count); //總取貨量 原取貨+現取貨
        //console.log(typeof(response.result.values[findRow-1][setArysite]));
        eval(caltext1);
        eval(caltext2); //計算剩餘庫存
        var wcol = sheetrange.resStock.gname + webform.gsheetcol + findRow.toString() //設定寫入欄位
        count = [[count]]

        writesheetrange(sheetrange.resStock.gid, wcol, count) //開始寫入數量

    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}

function GsubmitOrderData(getid, getname, aryV) { //取得最後一列，並寫入資料
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: getid,
        range: getname + "A:B"
    }).then(function (response) {

        //console.log(response.result.values)
        var dataLen = response.result.values.length + 1; //寫入的列數
        if (response.result.values[dataLen - 2][0] != buttonevent.todayDate()) { //比對最後一筆資料是否為今天日期 不是的話自動空一列
            dataLen = dataLen + 1;
        }
        webform.orderSheetRow = [dataLen, dataLen + productlist.products.length - 2] //輸出所在列數
        writesheetrangeAppend(getid, getname + "A" + dataLen.toString(), aryV)

    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}

function writesheetrange(setid, setrange, setvalues) { //寫入資料 update方法
    var body = {
        values: setvalues
    };
    gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: setid,
        range: setrange,
        valueInputOption: 'USER_ENTERED', //自動挑整格式
        resource: body
    }).then(function (response) {
        var result = response.result;
        console.log(`${result.updatedCells} cells updated.`);
    });

}

function handleClientLoad() { //啟動
    gapi.load('client:auth2', initClient);
}

function initClient() { //初始化
    gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
    }).then(function () {
        if (gapi.auth2.getAuthInstance().isSignedIn.get() == false) {
            gapi.auth2.getAuthInstance().signIn();
        } else {

        }
    });
}




function clearOrderSheet(gid, gname, row) { //刪除訂單
    gapi.client.sheets.spreadsheets.values.batchClear({
            spreadsheetId: gid,
            ranges: [gname + row[0] + ':' + row[1]]
        })
        .then(function (response) {}, function (reason) {
            console.error('error: ' + reason.result.error.message);
        });
}

function writesheetrangeAppend(setid, setrange, setvalues) { //append的方法
    gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: setid,
        range: setrange,
        valueInputOption: 'USER_ENTERED', //自動挑整格式
        majorDimension: "ROWS",
        values: setvalues

    }).then(function (response) {
        var result = response.result;
        console.log(`${result.updatedCells} cells updated.`);
    });

}


//receipt 專用
function getTodayOrder(getid, getname, oi, on, op, rn) { //取得今日訂單的第一列
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: getid,
        range: getname + "A:U" //讀取整個試算表，A:Z 必須包含發票 金額 資料
    }).then(function (response) {
        $("button").removeAttr('disabled') //激活送出紐
        var todayDate = new Date(receiptdiv.rdate);
        var aryA = []
        var aryPindex = []
        for (var i = 0; i < response.result.values.length; i++) { //提取日期
            aryA.push(response.result.values[i][0]);
        }

        var getV = aryA.indexOf(todayDate.toLocaleDateString()); //尋找當天日期列數
        receiptdiv.todayrow = getV + 1
        if (getV == -1) { //如果找不到返回
            $('#cantFindp').remove()
            $('#receiptdiv').append('<p id=\"cantFindp\">找不到資料</p>')
            return
        };
        //最後一個搜尋結果
        var lastdaterow = aryA.lastIndexOf(todayDate.toLocaleDateString());
        $('#cantFindp').remove() //如果有找到則刪除html"找不到"訊息
        //
        for (var i = getV; i < lastdaterow + 1; i++) {
            if (response.result.values[i][op] && response.result.values[i][op] > 0) { //有值且大於0(過濾序退)則執行 新增物件
                aryPindex.push(i - getV)
                receiptdiv.addOrdersObj(response.result.values[i][oi], response.result.values[i][on], response.result.values[i][op], response.result.values[i][rn]) //增加V-FOR物件
            }
        }

        receiptdiv.RowIndex = aryPindex //回傳各訂單開頭列數陣列，寫入用



    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}

//貨運統計 松果要另外
function shipget(web, col, final) { //取得貨運那蘭 web 哪個平台 ship 哪個貨運 col 貨運於哪個欄位(字母)
    var getid = eval("sheetrange." + web + "ID.gid")
    var getname = eval("sheetrange." + web + "ID.gname")
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: getid,
        range: getname + "A:" + col
    }).then(function (response) {

        if (final == 'final') { //解除鎖定按鈕
            $("#shipget").removeAttr('disabled')
        }

        var todayDate = new Date();
        var aryA = [] //存放日期
        var aryS = [] //存放貨運資料
        for (var i = 0; i < response.result.values.length; i++) { //提取日期
            aryA.push(new Date(response.result.values[i][0]).toLocaleDateString()); //new date()將文字轉為日期物件 toLocaleDateString再把他轉為文字 這樣日期格式會跟下面比對的統一
        }

        var getV = aryA.indexOf(todayDate.toLocaleDateString()); //尋找當天日期列數

        if (getV == -1) { //如果找不到返回
            return
        };
        var shipcolindex = response.result.values[getV].length - 1 //貨運的欄位INDEX bug第一張訂單貨運空的 會導致統計失敗
        var pcountCol = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.pcount")) //產品數量那欄
        if (web == 'buy123') { //如果是生活 偵測序退訂單用
            var pcountCol = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.oprice"))
        }

        for (var i = getV; i < response.result.values.length; i++) {

            if (response.result.values[i][shipcolindex] && response.result.values[i][pcountCol] > 0) { //有值極致偵測序退則執行 將貨運推至陣列

                aryS.push(response.result.values[i][shipcolindex])
            }

        }
        var sc = [] //計算宅配數量

        var ship = ['seven', 'family', 'life', 'OK']
        for (var oi = 0; oi < ship.length; oi++) {
            for (var i = 0; i < aryS.length; i++) {
                if (aryS[i].substr(0, 1) == shipMenu.shipName(ship[oi])) { //符合要尋找的貨運方式(只找第一個字) 將貨運推至陣列 shipMenu()轉成要尋找的文字 
                    sc.push(i)
                }
            }
            eval("shipMenu." + web + "." + ship[oi] + " = sc.length")
            sc = [] //陣列清空
        }





    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}
//print order
var fctnlist = {
    COLindex: function (txt) { //欄轉成數字
        return txt.charCodeAt(0) - 65
    },

    findtoday: function (ary) { //找當天日期的列數
        var aryA = []
        for (var i = 0; i < ary.length; i++) { //提取日期
            aryA.push(new Date(ary[i][0]).toLocaleDateString()); //new date()將文字轉為日期物件 toLocaleDateString再把他轉為文字 這樣日期格式會跟下面比對的統一
        }
        var todayDate = new Date();
        return aryA.indexOf(todayDate.toLocaleDateString())
    }
}


function printOrders(web, okey, name, iso, pname, ptype, pcount, pprice, ship, shipprice, oprice) { //
    var getid = eval("sheetrange." + web + "ID.gid")
    var getname = eval("sheetrange." + web + "ID.gname")
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: getid,
        range: getname + "A:Z" //讀取整個試算表，A:Z 必須包含發票 金額 資料
    }).then(function (response) {
        var aryO = [] //存放今日訂單
        //尋找日期列數
        var aryA = []
        for (var i = 0; i < response.result.values.length; i++) { //提取日期
            aryA.push(new Date(response.result.values[i][0]).toLocaleDateString()); //new date()將文字轉為日期物件 toLocaleDateString再把他轉為文字 這樣日期格式會跟下面比對的統一
        }
        var todayDate = new Date(printorderobj.rdate);
        var getR = aryA.indexOf(todayDate.toLocaleDateString())
        var getLastR = aryA.lastIndexOf(todayDate.toLocaleDateString()) //該日期的最後一列
        if (getR == -1) { //如果找不到返回
            $("button").removeAttr('disabled') //激活送出紐
            return
        };
        for (var i = getR; i < getLastR + 1; i++) { //從getR列開始提取今日訂單  到日期的最後一列 +1是包括最後一列
            if (response.result.values[i][okey]) { //如果key欄有值PUSH
                aryO.push(response.result.values[i]);
            }
        }
        var pushpdtindex = -1 //訂單的Index
        for (var i = 0; i < aryO.length; i++) {
            if (aryO[i][oprice] && aryO[i][oprice] > 0) { //總金額有值，輸入訂單資料
                if (web == 'songuo' || web == 'buy123') {
                    printorderobj.pushOobj(aryO[i][okey], aryO[i][name], aryO[i][ship], 0, aryO[i][oprice]) //如果是松果或生活運費為0
                } else if (web == 'LINE') {
                    printorderobj.pushOobj(aryO[i][name], "", aryO[i][ship], 0, aryO[i][oprice])
                } else {
                    printorderobj.pushOobj(aryO[i][okey], aryO[i][name], aryO[i][ship], aryO[i][shipprice], aryO[i][oprice])
                }
                pushpdtindex = pushpdtindex + 1
            }
            if (aryO[i][pcount] > 0 && pushpdtindex > -1) {
                //console.log(pushpdtindex)
                printorderobj.pushPobj(pushpdtindex, aryO[i][iso], aryO[i][pname], aryO[i][ptype], aryO[i][pcount], aryO[i][pprice])
            } //推訂單商品資料
            if (aryO[i][8] > 0 && web == 'songuo' && pushpdtindex > -1) { //松果
                printorderobj.pushPobj(pushpdtindex, aryO[i][iso], aryO[i][pname], aryO[i][ptype], aryO[i][pcount], aryO[i][pprice])
            }
        }
        $("button").removeAttr('disabled') //激活送出紐
    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}
//取貨單
function printporductslist(col) { //
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheetrange.resStock.gid,
        range: sheetrange.resStock.gname + "A:Q"
    }).then(function (response) {

        var aryL = [] //存放取貨表
        for (var i = 0; i < response.result.values.length; i++) { //提取資料
            if (response.result.values[i][col] && response.result.values[i][col] > 0) {
                aryL.push(response.result.values[i]);
            }
        }
        for (var i = 0; i < aryL.length; i++) { //去除剩餘數量>0
            if (isNaN(Number(aryL[i][14])) || Number(aryL[i][14]) > 0) { //大於0或是文字的
                aryL[i][14] = ""
            }
        }
        var nan_val
        for(var i =0;i<aryL.length;i++){
            
            if (aryL[i][16] == nan_val){
                aryL[i][16] = '?'
            }
        }
        //aryL.sort()
        aryL = aryL.sort(function (a, b) { //依位置排列
            //    if (!a[16]) {
            //        a[16] = "99"

            //    } else if (!b[16]) {
            //        b[16] = "99"
            //    }
            return a[16] > b[16] ? 1 : -1;

        });
        productL.productlist = aryL;
        $("button").removeAttr('disabled') //激活送出紐
    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}

function hctmark(web) { // 標記新竹商品，松果 生活沒辦法
    var getid = eval("sheetrange." + web + "ID.gid") //sheetID
    var getname = eval("sheetrange." + web + "ID.gname") //sheetName
    var getshipcol = eval("sheetrange." + web + "ID.col.oship") //取得欄位的字母
    var getshipcolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.oship")) //取得欄位的index
    var getisoindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.piso"))
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: getid,
        range: getname + "A:" + getshipcol //日期到貨運
    }).then(function (response) {
            var getR = fctnlist.findtoday(response.result.values); //尋找當天日期列數
            var aryS = []
            if (getR == -1) { //如果找不到返回
                $("button").removeAttr('disabled') //激活送出紐
                return
            }

            var ostart = -1
            for (var i = getR; i < response.result.values.length; i++) { //從getR列開始提取今日訂單 
                if (ostart == 1 && response.result.values[i][getshipcolindex]) { //如果本列有值且ostart=1 為下一筆訂單，則傳回-1 結束訂單
                    ostart = -1
                }
                if (response.result.values[i][getshipcolindex] == "竹" || response.result.values[i][getshipcolindex] == "新竹") { //如果是新竹則執行
                    ostart = 1 //訂單開始
                }
                if (ostart == 1) { //如果訂單開始則標記資料
                    productL.hctproducts.push(response.result.values[i][getisoindex])

                    for (var ii = 0; ii < productL.productlist.length; ii++) {
                        if (response.result.values[i][getisoindex] == productL.productlist[ii][1]) { //有找到資料則標記框線
                            $('#productsdiv div:eq(' + ((ii * 8) + 6) + ')').css({
                                'background': 'url(mark.png) no-repeat',
                                'background-position': '26px',
                                'background-size': '16px 16px'
                            }); //*8 是算出來的
                        }

                    }
                }

            }

        },
        function (response) {
            console.log('Error: ' + response.result.error.message);
        });

}

function cancelapi(web, rpNum, why) { // 序退 yahoo 要另外寫
    var getid = eval("sheetrange." + web + "ID.gid") //sheetID
    var getname = eval("sheetrange." + web + "ID.gname") //sheetName
    var getrpcolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.oreceipt")) //取得欄位的index 發票
    var getisocolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.piso")) //取得欄位的index ISO
    var getcountcolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.pcount")) //取得欄位的index 數量
    var gettotalcolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.pallprice")) //取得欄位的index 總價
    var getspcolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.oshipprice")) //取得欄位的index 運費
    var getopcolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.oprice")) //取得欄位的index 發票金額
    var getidcolindex = fctnlist.COLindex(eval("sheetrange." + web + "ID.col.oid")) //取得欄位的index 訂單編號
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: getid,
        range: getname + "A:Z"
    }).then(function (response) {
            var rpAry = []

            $("#msg").html('');
            for (var i = 0; i < response.result.values.length; i++) { //提取發票
                rpAry.push(response.result.values[i][getrpcolindex])
            }

            var rpRow = rpAry.indexOf(rpNum) //訂單起始列
            if (rpRow == -1) { //找不到則返回
                $("#msg").html('找不到發票');
                $("#cancelbtn").removeAttr('disabled') //激活送出紐
                return
            }
            //寫入原本發票資料
            var wrorpRange = getname + eval("sheetrange." + web + "ID.col.oreceipt") + (rpRow + 1) //原發票位置
            var wrorpVal = [[
                    '序退' + response.result.values[rpRow][getrpcolindex] + " " + (new Date().toLocaleDateString()).substring(5) + " " + why
                ]] //原發票資料寫入
            writesheetrange(getid, wrorpRange, wrorpVal)
            var endRow //訂單最後一列
            try {
                for (var i = rpRow; i < response.result.values.length; i++) { //yahoo會沒用
                    endRow = i
                    if (response.result.values[i][getidcolindex] != response.result.values[i + 1][getidcolindex]) {
                        break
                    }
                }
            } catch {

            }


            var putval = [] //輸出資料
            for (var i = rpRow; i < endRow + 1; i++) {
                putval.push(response.result.values[i])
            }

            //更改資料
            putval[0][getspcolindex] = Number(putval[0][getspcolindex]) * (-1)
            putval[0][getopcolindex] = Number(putval[0][getopcolindex]) * (-1)
            putval[0][getrpcolindex] = '序退' + putval[0][getrpcolindex] + " " + putval[0][0].substring(5) + why

            var iso
            var count
            for (var i = 0; i < putval.length; i++) {

                iso = putval[i][getisocolindex]
                count = putval[i][getcountcolindex]
                cancelprd(iso, count, 0)

                putval[i][0] = new Date().toLocaleDateString()
                putval[i][getcountcolindex] = Number(putval[i][getcountcolindex]) * (-1)
                putval[i][gettotalcolindex] = Number(putval[i][gettotalcolindex]) * (-1)

            }
            //寫入資料
            GsubmitOrderData(getid, getname, putval)


            $("#msg").html('序退完成');
            $("#cancelbtn").removeAttr('disabled') //激活送出紐
        },
        function (response) {
            console.log('Error: ' + response.result.error.message);
        });

}

function cancelprd(iso, count, pindex) { //序退加回商品
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheetrange.resStock.gid,
        range: sheetrange.resStock.gname + "B:H" //原本只有取道O蘭，但因為鎖定的取貨蘭 包括本身即之後的欄位為空，會導致陣列較短，無法取值計算 而沒法附值
    }).then(function (response) {
        var stockISOAry = [];
        var setArysite
        //console.log(response.result.values)
        for (var i = 0; i < response.result.values.length; i++) { //提取ISO
            stockISOAry.push(response.result.values[i][0]);
        }
        var findRow = stockISOAry.indexOf(iso) + 1; //找到的ISO列數
        if (pindex) { //最後一個商品時//解放按鈕 -2是因為index從0開始 商品列又固定多1  因為後面找不到值會return 所以在這

        }
        if (findRow - 1 == -1 || iso == "") { //如果找不到ISO 會返回-1 iso為空白字元 會自動找到80列 所以強制RETURN
            $("#msg").append('<br>找不到商品' + iso);
            return
        }
        if (response.result.values[findRow - 1][fctnlist.COLindex(sheetrange.resStock.col.pcount) - 1] == 'over') { //-1因為從B欄開始
            var nowcount = 0
        } else {
            var nowcount = response.result.values[findRow - 1][fctnlist.COLindex(sheetrange.resStock.col.pcount) - 1]
            nowcount = Number(nowcount)
        }


        var wcol = sheetrange.resStock.gname + sheetrange.resStock.col.pcount + findRow.toString() //設定寫入欄位
        count = [[Number(count) + nowcount]]
        writesheetrange(sheetrange.resStock.gid, wcol, count) //開始寫入數量

    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}

//扣數量
function takeprdapi(takecol) {
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheetrange.resStock.gid,
        range: sheetrange.resStock.gname + "A:R"
    }).then(function (response) {
        var gapiisoAry = []
        var takeColAry = []
        for (var i = 0; i < response.result.values.length; i++) {
            gapiisoAry.push(response.result.values[i][1]) //提取ISO碼

        }
        for (var i = 0; i < response.result.values.length; i++) {
            takeColAry.push(response.result.values[i][fctnlist.COLindex(takecol)]) //提取已取貨數量

        }

        for (var i = 0; i < takeprd.isoAry.length; i++) { //尋找各ISO位置

            var isorow = gapiisoAry.indexOf(takeprd.isoAry[i]) //寫入的ISO 列數 //若錯誤要跳出資料******
            if (isorow == -1) {
                $("#errordiv").append("<br>" + takeprd.isoAry[i] + '  錯誤')
            } else {
                takeColAry[isorow] = Number(takeColAry[isorow]) + Number(takeprd.countAry[i]) //變更已取貨數量
            }
        }


        //寫入資料準備
        var wrColAry = []
        for (var i = 0; i < takeColAry.length; i++) {
            wrColAry.push([takeColAry[i]])
        }
        writesheetrange(sheetrange.resStock.gid, sheetrange.resStock.gname + takecol + "1", wrColAry) //寫入資料
        $("#errordiv").append("<br>完成")


    }, function (response) {
        console.log('Error: ' + response.result.error.message);
    });

}
